from webapp_discover.php_webapp import PhpWebApp

import os
import re

RE_VERSION = re.compile("""["']PMA_VERSION["']\s*,\s*['"](\d+(\.\d+)+)['"]""")


class PhpmyadminWebApp(PhpWebApp):
    webapp_name = "PhpMyAdmin"
    webapp_files = [
        'ChangeLog',
        'LICENSE',
        'README',
        'browse_foreigners.php',
        'changelog.php',
        'chk_rel.php',
        'config.sample.inc.php',
        'db_create.php',
        'db_datadict.php',
        'db_export.php',
        'db_import.php',
        'db_operations.php',
        'db_printview.php',
        'db_qbe.php',
        'db_search.php',
        'db_sql.php',
        'db_structure.php',
        'export.php',
        'favicon.ico',
        'import.php',
        'index.php',
        'js/functions.js',
        'js/indexes.js',
        'js/keyhandler.js',
        'js/navigation.js',
        'js/querywindow.js',
        'js/server_privileges.js',
        'js/tbl_change.js',
        'libraries/Config.class.php',
        'libraries/File.class.php',
        'libraries/List.class.php',
        'libraries/List_Database.class.php',
        'libraries/StorageEngine.class.php',
        'libraries/Table.class.php',
        'libraries/Theme.class.php',
        'libraries/Theme_Manager.class.php',
        'libraries/bookmark.lib.php',
        'libraries/charset_conversion.lib.php',
        'libraries/check_user_privileges.lib.php',
        'libraries/cleanup.lib.php',
        'libraries/common.inc.php',
        'libraries/config.default.php',
        'libraries/core.lib.php',
        'libraries/db_common.inc.php',
        'libraries/db_info.inc.php',
        'libraries/db_table_exists.lib.php',
        'libraries/display_change_password.lib.php',
        'libraries/display_create_database.lib.php',
        'libraries/display_create_table.lib.php',
        'libraries/display_export.lib.php',
        'libraries/display_import.lib.php',
        'libraries/display_select_lang.lib.php',
        'libraries/engines/bdb.lib.php',
        'libraries/engines/berkeleydb.lib.php',
        'libraries/engines/binlog.lib.php',
        'libraries/engines/innobase.lib.php',
        'libraries/engines/innodb.lib.php',
        'libraries/engines/memory.lib.php',
        'libraries/engines/merge.lib.php',
        'libraries/engines/mrg_myisam.lib.php',
        'libraries/engines/myisam.lib.php',
        'libraries/engines/ndbcluster.lib.php',
        'libraries/iconv_wrapper.lib.php',
        'libraries/import.lib.php',
        'libraries/information_schema_relations.lib.php',
        'libraries/ip_allow_deny.lib.php',
        'libraries/js_escape.lib.php',
        'libraries/kanji-encoding.lib.php',
        'libraries/mult_submits.inc.php',
        'libraries/mysql_charsets.lib.php',
        'libraries/opendocument.lib.php',
        'libraries/plugin_interface.lib.php',
        'libraries/relation.lib.php',
        'libraries/relation_cleanup.lib.php',
        'libraries/sanitizing.lib.php',
        'libraries/select_lang.lib.php',
        'libraries/select_server.lib.php',
        'libraries/server_common.inc.php',
        'libraries/session.inc.php',
        'libraries/sql_query_form.lib.php',
        'libraries/sqlparser.data.php',
        'libraries/sqlparser.lib.php',
        'libraries/sqlvalidator.class.php',
        'libraries/sqlvalidator.lib.php',
        'libraries/tbl_indexes.lib.php',
        'libraries/tbl_info.inc.php',
        'libraries/tcpdf/tcpdf.php',
        'libraries/transformations.lib.php',
        'libraries/url_generating.lib.php',
        'libraries/zip.lib.php',
        'license.php',
        'navigation.php',
        'phpinfo.php',
        'phpmyadmin.css.php',
        'pmd_display_field.php',
        'pmd_general.php',
        'pmd_pdf.php',
        'pmd_relation_new.php',
        'pmd_relation_upd.php',
        'pmd_save_pos.php',
        'print.css',
        'querywindow.php',
        'server_binlog.php',
        'server_collations.php',
        'server_databases.php',
        'server_engines.php',
        'server_export.php',
        'server_import.php',
        'server_privileges.php',
        'server_sql.php',
        'server_status.php',
        'server_variables.php',
        'show_config_errors.php',
        'sql.php',
        'tbl_addfield.php',
        'tbl_change.php',
        'tbl_create.php',
        'tbl_export.php',
        'tbl_import.php',
        'tbl_indexes.php',
        'tbl_move_copy.php',
        'tbl_operations.php',
        'tbl_printview.php',
        'tbl_relation.php',
        'tbl_replace.php',
        'tbl_row_action.php',
        'tbl_select.php',
        'tbl_sql.php',
        'tbl_structure.php',
        'themes.php',
    ] # Versions 2.11 and 4.1.6

    ## Source
    #git log --tags --date-order --simplify-by-decoration --pretty='format:%ai %d' | perl -n -e'/(\d\d\d\d-\d\d-\d\d)[^\(]+\(RELEASE_(\d+)_(\d+)_(\d+)(_(\d+))?(\)|,)/ && print ' \'$2.$3.$4.$6\': { \'date\': \'$1\'},\n''
    versions = {
        '4.1.6': {'date': '2014-01-26'},
        '4.1.5': {'date': '2014-01-17'},
        '4.1.4': {'date': '2014-01-07'},
        '4.1.3': {'date': '2013-12-31'},
        '4.1.2': {'date': '2013-12-23'},
        '4.1.1': {'date': '2013-12-17'},
        '4.1.0': {'date': '2013-12-11'},
        '4.0.10': {'date': '2013-12-04'},
        '4.0.9': {'date': '2013-11-04'},
        '4.0.8': {'date': '2013-10-06'},
        '4.0.7': {'date': '2013-09-23'},
        '4.0.6': {'date': '2013-09-05'},
        '4.0.5': {'date': '2013-08-04'},
        '4.0.4.2': {'date': '2013-07-28'},
        '3.5.8.2': {'date': '2013-07-28'},
        '4.0.4.1': {'date': '2013-06-30'},
        '4.0.4': {'date': '2013-06-17'},
        '4.0.3': {'date': '2013-06-05'},
        '4.0.2': {'date': '2013-05-24'},
        '4.0.1': {'date': '2013-05-14'},
        '4.0.0': {'date': '2013-05-03'},
        '3.5.8.1': {'date': '2013-04-24'},
        '3.5.8': {'date': '2013-04-08'},
        '3.5.7': {'date': '2013-02-15'},
        '3.5.6': {'date': '2013-01-28'},
        '3.5.5': {'date': '2012-12-20'},
        '3.5.4': {'date': '2012-11-16'},
        '3.5.3': {'date': '2012-10-08'},
        '3.5.2.2': {'date': '2012-08-12'},
        '3.4.11.1': {'date': '2012-08-12'},
        '3.5.2.1': {'date': '2012-08-03'},
        '3.5.2': {'date': '2012-07-07'},
        '3.5.1': {'date': '2012-05-03'},
        '3.4.11': {'date': '2012-04-14'},
        '3.5.0': {'date': '2012-04-07'},
        '3.4.10.2': {'date': '2012-03-28'},
        '3.4.10.1': {'date': '2012-02-18'},
        '3.4.10': {'date': '2012-02-14'},
        '3.4.9': {'date': '2011-12-21'},
        '3.4.8': {'date': '2011-12-01'},
        '3.4.7.1': {'date': '2011-11-10'},
        '3.3.10.5': {'date': '2011-11-10'},
        '3.4.7': {'date': '2011-10-23'},
        '3.4.6': {'date': '2011-10-16'},
        '3.4.5': {'date': '2011-09-14'},
        '3.4.4': {'date': '2011-08-24'},
        '3.3.10.4': {'date': '2011-08-24'},
        '3.4.3.2': {'date': '2011-07-23'},
        '3.3.10.3': {'date': '2011-07-23'},
        '3.4.3.1': {'date': '2011-07-02'},
        '3.3.10.2': {'date': '2011-07-02'},
        '3.4.3': {'date': '2011-06-27'},
        '3.4.2': {'date': '2011-06-07'},
        '3.4.1': {'date': '2011-05-20'},
        '3.3.10.1': {'date': '2011-05-20'},
        '3.4.0': {'date': '2011-05-11'},
        '3.3.10': {'date': '2011-03-19'},
        '3.3.9.2': {'date': '2011-02-11'},
        '2.11.11.3': {'date': '2011-02-11'},
        '3.3.9.1': {'date': '2011-02-08'},
        '2.11.11.2': {'date': '2011-02-08'},
        '3.3.9': {'date': '2011-01-03'},
        '3.3.8.1': {'date': '2010-11-29'},
        '2.11.11.1': {'date': '2010-11-29'},
        '3.3.8': {'date': '2010-10-25'},
        '3.3.7': {'date': '2010-09-07'},
        '2.11.11': {'date': '2010-09-07'},
        '3.3.6': {'date': '2010-08-28'},
        '3.3.5.1': {'date': '2010-08-20'},
        '2.11.10.1': {'date': '2010-08-20'},
        '3.3.5': {'date': '2010-07-26'},
        '3.3.4': {'date': '2010-06-28'},
        '3.3.3': {'date': '2010-05-10'},
        '3.3.2': {'date': '2010-04-13'},
        '3.3.1': {'date': '2010-03-16'},
        '3.3.0': {'date': '2010-03-07'},
        '3.2.5': {'date': '2010-01-10'},
        '2.11.10': {'date': '2009-12-07'},
        '3.2.4': {'date': '2009-12-02'},
        '3.2.3': {'date': '2009-10-30'},
        '2.11.9.6': {'date': '2009-10-12'},
        '3.2.2.1': {'date': '2009-10-12'},
        '3.2.2': {'date': '2009-09-13'},
        '3.2.0.1': {'date': '2009-06-30'},
        '3.2.0': {'date': '2009-06-15'},
        '3.1.5': {'date': '2009-05-15'},
        '3.1.4': {'date': '2009-04-25'},
        '3.1.3.2': {'date': '2009-04-14'},
        '2.11.9.5': {'date': '2009-03-24'},
        '3.1.3.1': {'date': '2009-03-24'},
        '3.1.3': {'date': '2009-02-28'},
        '3.1.2': {'date': '2009-01-19'},
        '2.11.9.4': {'date': '2008-12-09'},
        '3.1.1': {'date': '2008-12-06'},
        '3.1.0': {'date': '2008-11-28'},
        '2.11.9.3': {'date': '2008-10-30'},
        '3.0.1.1': {'date': '2008-10-30'},
        '3.0.1': {'date': '2008-10-22'},
        '3.0.0': {'date': '2008-09-27'},
        '2.11.9.2': {'date': '2008-09-22'},
        '2.11.9.1': {'date': '2008-09-15'},
        '2.11.9': {'date': '2008-08-28'},
        '2.11.8.1': {'date': '2008-07-28'},
        '2.11.8': {'date': '2008-07-28'},
        '2.11.7.1': {'date': '2008-07-15'},
        '2.11.7': {'date': '2008-06-23'},
        '2.11.6': {'date': '2008-04-29'},
        '2.11.5.2': {'date': '2008-04-22'},
        '2.11.5.1': {'date': '2008-03-29'},
        '2.11.5': {'date': '2008-03-01'},
        '2.11.4': {'date': '2008-01-12'},
        '2.11.3': {'date': '2007-12-08'},
        '2.11.2.2': {'date': '2007-11-20'},
        '2.11.2.1': {'date': '2007-11-11'},
        '2.11.2': {'date': '2007-10-27'},
        '2.11.1.2': {'date': '2007-10-17'},
        '2.11.1.1': {'date': '2007-10-15'},
        '2.11.1': {'date': '2007-09-20'},
        '2.11.0': {'date': '2007-08-21'},
        '2.10.3': {'date': '2007-07-20'},
        '2.10.2': {'date': '2007-06-15'},
        '2.10.0.2': {'date': '2007-03-02'},
        '2.10.0.1': {'date': '2007-02-28'},
        '2.10.0': {'date': '2007-02-28'},
        '2.9.2': {'date': '2007-01-16'},
        '2.9.1.1': {'date': '2006-11-19'},
        '2.9.0.2': {'date': '2006-10-07'},
        '2.9.0.1': {'date': '2006-10-01'},
        '2.9.0': {'date': '2006-08-10'},
        '2.8.0.4': {'date': '2006-01-29'},
        '2.8.2.4': {'date': '2006-01-25'},
        '2.5.6': {'date': '2004-01-12'},
        '2.5.4': {'date': '2003-10-01'},
        '2.5.2': {'date': '2003-07-22'},
        '2.5.1': {'date': '2003-06-02'},
        '2.5.0': {'date': '2003-05-11'},
        '2.4.0': {'date': '2003-02-23'},
        '2.3.2': {'date': '2002-10-08'},
        '2.3.1': {'date': '2002-09-30'},
        '2.3.0': {'date': '2002-08-12'},
        '2.2.6': {'date': '2002-04-21'},
        '2.2.5': {'date': '2002-03-22'},
        '2.2.4': {'date': '2002-02-19'},
        '2.2.3': {'date': '2002-01-06'},
        '2.2.2': {'date': '2001-12-02'},
        '2.2.1': {'date': '2001-10-24'},
        '2.2.0': {'date': '2001-08-30'},
    }

    def get_version(self, path):

        conf_path = os.path.join(path, 'libraries/Config.class.php')
        if os.path.exists(conf_path):
            cont = open(conf_path).read()
            m = RE_VERSION.search(cont)
            if m is not None:
                return (m.group(1))


    pass
