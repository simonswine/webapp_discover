from webapp_discover.php_webapp import PhpWebApp
import re
import os

RE_VERSION = re.compile("""["']VERSION["']\s*,\s*['"](\d+(\.\d+)+)['"]""")
RE_VERSION_CHANGELOG = re.compile("""drupal\s+(\d+(\.\d+)+),""")


class DrupalWebApp(PhpWebApp):
    webapp_name = "Drupal"
    webapp_files = [
        '.htaccess',
        'cron.php',
        'includes/common.inc',
        'includes/module.inc',
        'includes/theme.inc',
        'includes/xmlrpc.inc',
        'includes/xmlrpcs.inc',
        'index.php',
        'misc/druplicon.png',
        'scripts/code-clean.sh',
        'scripts/cron-lynx.sh',
        'update.php',
        'xmlrpc.php'
    ] # Versions 4.0 and 7.2

    # Source
    ## curl -s https://raw2.github.com/drupal/drupal/7.x/CHANGELOG.txt | perl -n -e'/(\d+\.\d+)\s*,\s*(\d\d\d\d-\d\d-\d\d)/ && print " \"$1\": { \"date\": \"$2\"},\n"'
    versions = {
        '7.26': {'date': '2014-01-15'},
        '7.25': {'date': '2014-01-02'},
        '7.24': {'date': '2013-11-20'},
        '7.23': {'date': '2013-08-07'},
        '7.22': {'date': '2013-04-03'},
        '7.21': {'date': '2013-03-06'},
        '7.20': {'date': '2013-02-20'},
        '7.19': {'date': '2013-01-16'},
        '7.18': {'date': '2012-12-19'},
        '7.17': {'date': '2012-11-07'},
        '7.16': {'date': '2012-10-17'},
        '7.15': {'date': '2012-08-01'},
        '7.12': {'date': '2012-02-01'},
        '7.11': {'date': '2012-02-01'},
        '7.10': {'date': '2011-12-05'},
        '7.9': {'date': '2011-10-26'},
        '7.8': {'date': '2011-08-31'},
        '7.7': {'date': '2011-07-27'},
        '7.6': {'date': '2011-07-27'},
        '7.5': {'date': '2011-07-27'},
        '7.4': {'date': '2011-06-29'},
        '7.3': {'date': '2011-06-29'},
        '7.2': {'date': '2011-05-25'},
        '7.1': {'date': '2011-05-25'},
        '7.0': {'date': '2011-01-05'},
        '6.22': {'date': '2011-05-25'},
        '6.21': {'date': '2011-05-25'},
        '6.20': {'date': '2010-12-15'},
        '6.19': {'date': '2010-08-11'},
        '6.18': {'date': '2010-08-11'},
        '6.17': {'date': '2010-06-02'},
        '6.16': {'date': '2010-03-03'},
        '6.15': {'date': '2009-12-16'},
        '6.14': {'date': '2009-09-16'},
        '6.13': {'date': '2009-07-01'},
        '6.12': {'date': '2009-05-13'},
        '6.11': {'date': '2009-04-29'},
        '6.10': {'date': '2009-02-25'},
        '6.9': {'date': '2009-01-14'},
        '6.8': {'date': '2008-12-11'},
        '6.7': {'date': '2008-12-10'},
        '6.6': {'date': '2008-10-22'},
        '6.5': {'date': '2008-10-08'},
        '6.4': {'date': '2008-08-13'},
        '6.3': {'date': '2008-07-09'},
        '6.2': {'date': '2008-04-09'},
        '6.1': {'date': '2008-02-27'},
        '6.0': {'date': '2008-02-13'},
        '5.23': {'date': '2010-08-11'},
        '5.22': {'date': '2010-03-03'},
        '5.21': {'date': '2009-12-16'},
        '5.20': {'date': '2009-09-16'},
        '5.19': {'date': '2009-07-01'},
        '5.18': {'date': '2009-05-13'},
        '5.17': {'date': '2009-04-29'},
        '5.16': {'date': '2009-02-25'},
        '5.15': {'date': '2009-01-14'},
        '5.14': {'date': '2008-12-11'},
        '5.13': {'date': '2008-12-10'},
        '5.12': {'date': '2008-10-22'},
        '5.11': {'date': '2008-10-08'},
        '5.10': {'date': '2008-08-13'},
        '5.9': {'date': '2008-07-23'},
        '5.8': {'date': '2008-07-09'},
        '5.7': {'date': '2008-01-28'},
        '5.6': {'date': '2008-01-10'},
        '5.5': {'date': '2007-12-06'},
        '5.4': {'date': '2007-12-05'},
        '5.3': {'date': '2007-10-17'},
        '5.2': {'date': '2007-07-26'},
        '5.1': {'date': '2007-01-29'},
        '5.0': {'date': '2007-01-15'},
        '7.11': {'date': '2008-01-10'},
        '7.10': {'date': '2007-12-06'},
        '7.9': {'date': '2007-12-05'},
        '7.8': {'date': '2007-10-17'},
        '7.7': {'date': '2007-07-26'},
        '7.6': {'date': '2007-01-29'},
        '7.5': {'date': '2007-01-05'},
        '7.4': {'date': '2006-10-18'},
        '7.3': {'date': '2006-08-02'},
        '7.2': {'date': '2006-06-01'},
        '7.1': {'date': '2006-05-24'},
        '7.0': {'date': '2006-05-01'},
        '6.11': {'date': '2007-01-05'},
        '6.10': {'date': '2006-10-18'},
        '6.9': {'date': '2006-08-02'},
        '6.8': {'date': '2006-06-01'},
        '6.7': {'date': '2006-05-24'},
        '6.6': {'date': '2006-03-13'},
        '6.5': {'date': '2005-12-12'},
        '6.4': {'date': '2005-11-30'},
        '6.3': {'date': '2005-08-15'},
        '6.2': {'date': '2005-06-29'},
        '6.1': {'date': '2005-06-01'},
        '6.0': {'date': '2005-04-15'},
        '5.8': {'date': '2006-03-13'},
        '5.7': {'date': '2005-12-12'},
        '5.6': {'date': '2005-11-30'},
        '5.5': {'date': '2005-08-15'},
        '5.4': {'date': '2005-06-29'},
        '5.3': {'date': '2005-06-01'},
        '5.2': {'date': '2005-01-15'},
        '5.1': {'date': '2004-12-01'},
        '5.0': {'date': '2004-10-18'},
        '4.3': {'date': '2005-06-01'},
        '4.2': {'date': '2004-07-04'},
        '4.1': {'date': '2004-05-01'},
        '4.0': {'date': '2004-04-01'},
        '3.2': {'date': '2004-01-01'},
        '3.1': {'date': '2003-12-01'},
        '3.0': {'date': '2003-11-01'},
        '2.0': {'date': '2003-08-01'},
        '1.0': {'date': '2003-02-01'},
    }


    def get_version(self, path):

        # Versions >= 6.0
        for conf in [
            'includes/bootstrap.inc',
            'modules/system/system.module',
        ]:
            conf_path = os.path.join(path, conf)
            if os.path.exists(conf_path):
                cont = open(conf_path).read()
                m = RE_VERSION.search(cont)
                if m is not None:
                    return (m.group(1))

        # Older Versions from changelog
        conf_path = os.path.join(path, 'CHANGELOG')
        if os.path.exists(conf_path):
            cont = open(conf_path).read()
            m = RE_VERSION_CHANGELOG.search(cont)
            if m is not None:
                return (m.group(1))

